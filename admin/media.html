<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ConSySencI.A — Mídia</title>
  <meta name="color-scheme" content="dark"/>
  <style>
    :root{--bg:#050a08;--bg2:#07120d;--line:rgba(0,255,163,.18);--line2:rgba(0,255,163,.10);--txt:rgba(236,255,247,.92);--muted:rgba(236,255,247,.65);--muted2:rgba(236,255,247,.45);--green:#00ffa3;--red:#ff4d6d;--shadow:0 18px 50px rgba(0,0,0,.55);--r:22px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--txt);
      background:radial-gradient(900px 520px at 20% 15%, rgba(0,255,163,.16), transparent 55%),
      radial-gradient(700px 420px at 75% 30%, rgba(0,255,163,.10), transparent 60%),
      linear-gradient(180deg,var(--bg),var(--bg2));}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 70px}
    .top{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:14px;border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg,rgba(0,255,163,.08),rgba(0,0,0,.18));box-shadow:var(--shadow);position:sticky;top:10px;z-index:10;backdrop-filter:blur(10px);}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .dot{width:12px;height:12px;border-radius:999px;background:var(--green);box-shadow:0 0 0 6px rgba(0,255,163,.12),0 0 24px rgba(0,255,163,.35)}
    h1{margin:0;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{margin:4px 0 0;color:var(--muted);font-size:13px}
    .btn{border:1px solid var(--line);background:rgba(0,255,163,.06);color:var(--txt);padding:10px 12px;border-radius:999px;font-weight:650;font-size:13px;cursor:pointer}
    .btn:hover{border-color:rgba(0,255,163,.35);background:rgba(0,255,163,.10)}
    .btn.ghost{background:rgba(0,0,0,.22)}
    .btn.danger{border-color:rgba(255,77,109,.35);background:rgba(255,77,109,.10)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:980px){.grid{grid-template-columns:1.05fr .95fr}}
    .card{border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.10))}
    .head{padding:16px;border-bottom:1px solid var(--line2);background:linear-gradient(180deg,rgba(0,255,163,.06),transparent)}
    .head h2{margin:0;font-size:16px}
    .head p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .body{padding:16px}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:12px}
    input,select,textarea{width:100%;padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(0,0,0,.35);color:var(--txt);outline:none;font-size:14px}
    textarea{min-height:140px;resize:vertical;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{flex:1 1 220px;min-width:200px}
    .result{margin-top:12px;padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(0,0,0,.25);white-space:pre;overflow:auto;max-height:280px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;line-height:1.35}
    .ok{border-color:rgba(0,255,163,.35);background:rgba(0,255,163,.06)}
    .err{border-color:rgba(255,77,109,.35);background:rgba(255,77,109,.08);color:rgba(255,240,245,.92)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line2);border-radius:16px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid rgba(0,255,163,.08);font-size:12.5px;vertical-align:top}
    th{color:var(--muted);text-align:left;background:rgba(0,255,163,.04)}
    .small{font-size:12px;color:var(--muted2)}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line2);background:rgba(0,0,0,.20);color:var(--muted);font-size:12px}
    .click{cursor:pointer}
    .preview{
      margin-top:10px;border:1px solid var(--line2);border-radius:18px;overflow:hidden;background:rgba(0,0,0,.20)
    }
    .preview img{display:block;width:100%;height:auto}
    .preview .meta{padding:10px;color:var(--muted);font-size:12px;border-top:1px solid rgba(0,255,163,.08)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div style="min-width:0">
          <h1>Mídia</h1>
          <p class="sub">media_list • media_upsert • media_delete</p>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <a class="btn ghost" href="/admin/index.html">Voltar</a>
        <a class="btn ghost" href="/admin/events.html">Eventos</a>
        <a class="btn ghost" href="/admin/rules.html">Regras</a>
        <button class="btn danger" id="btnLogout" type="button">Sair</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="head">
          <h2>Catálogo</h2>
          <p>Busca no JSON completo. Clique em um item para carregar no editor.</p>
        </div>
        <div class="body">
          <div class="row">
            <div class="field">
              <label>Filtro</label>
              <input id="q" placeholder="Ex: nome, tag, categoria, url..." autocomplete="off" spellcheck="false"/>
            </div>
            <button class="btn" id="btnLoad" type="button">Carregar</button>
            <button class="btn ghost" id="btnExport" type="button">Export JSON</button>
          </div>

          <div id="diag" class="result ok">{ "ok": true, "info": "Carregue para ver a mídia." }</div>

          <div style="margin-top:12px;overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="width:110px">id</th>
                  <th style="width:220px">nome</th>
                  <th style="width:150px">tipo</th>
                  <th>url</th>
                </tr>
              </thead>
              <tbody id="tb">
                <tr><td colspan="4" class="small">Sem dados ainda.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="head">
          <h2>Editor</h2>
          <p>Cadastre/edite itens (imagem/link). O sistema envia o objeto completo para <b>media_upsert</b>.</p>
        </div>
        <div class="body">
          <div class="row">
            <div class="field">
              <label>ID (opcional)</label>
              <input id="id" placeholder="uuid / id / slug..." autocomplete="off" spellcheck="false"/>
            </div>
            <div class="field">
              <label>Nome</label>
              <input id="name" placeholder="Ex: Banner Nível 1" autocomplete="off" spellcheck="false"/>
            </div>
            <div class="field">
              <label>Tipo</label>
              <select id="type">
                <option value="image" selected>image</option>
                <option value="link">link</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>URL</label>
              <input id="url" placeholder="https://..." autocomplete="off" spellcheck="false"/>
            </div>
            <div class="field">
              <label>Tags (opcional)</label>
              <input id="tags" placeholder="ex: nivel1, hero, oficial" autocomplete="off" spellcheck="false"/>
            </div>
          </div>

          <label style="margin-top:10px">JSON do item</label>
          <textarea id="json" spellcheck="false"></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnSave" type="button">Salvar (Upsert)</button>
            <button class="btn ghost" id="btnNew" type="button">Novo item</button>
            <button class="btn danger" id="btnDelete" type="button">Deletar</button>
          </div>

          <div id="res" class="result ok">{ "ok": true, "info": "Pronto." }</div>

          <div class="preview" id="preview" style="display:none">
            <img id="img" alt="preview"/>
            <div class="meta" id="meta"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script src="/admin/boot.js"></script>
  <script>
    const FN_LIST   = "/.netlify/functions/media_list";
    const FN_UPSERT = "/.netlify/functions/media_upsert";
    const FN_DELETE = "/.netlify/functions/media_delete";

    const el = (id)=>document.getElementById(id);
    const pretty = (x)=>ADMIN.pretty(x);
    let lastList = [];

    function setBox(id, ok, obj){
      const box = el(id);
      box.className = "result " + (ok ? "ok":"err");
      box.textContent = pretty(obj);
    }

    function escapeHTML(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function filterList(list, query){
      const q = (query || "").trim().toLowerCase();
      if (!q) return list;
      return list.filter(r => JSON.stringify(r).toLowerCase().includes(q));
    }

    function summarize(item){
      const id = item.id ?? item.key ?? item.media_id ?? "";
      const name = item.name ?? item.title ?? item.filename ?? "(sem nome)";
      const type = item.type ?? item.kind ?? "image";
      const url = item.url ?? item.href ?? item.src ?? "";
      return { id, name, type, url };
    }

    function renderTable(list){
      const tb = el("tb");
      tb.innerHTML = "";
      if (!list.length){
        tb.innerHTML = `<tr><td colspan="4" class="small">Sem mídia.</td></tr>`;
        return;
      }
      list.forEach((m, idx)=>{
        const s = summarize(m);
        const tr = document.createElement("tr");
        tr.className = "click";
        tr.innerHTML = `
          <td class="small">${escapeHTML(s.id || ("#" + (idx+1)))}</td>
          <td>${escapeHTML(s.name)}</td>
          <td><span class="tag">${escapeHTML(String(s.type))}</span></td>
          <td class="small">${escapeHTML(s.url)}</td>
        `;
        tr.onclick = ()=>loadIntoEditor(m);
        tb.appendChild(tr);
      });
    }

    function updatePreview(){
      const type = el("type").value;
      const url = (el("url").value || "").trim();
      const box = el("preview");
      if (type !== "image" || !url){
        box.style.display = "none";
        return;
      }
      el("img").src = url;
      el("meta").textContent = url;
      box.style.display = "block";
    }

    function loadIntoEditor(item){
      const s = summarize(item);
      el("id").value = s.id;
      el("name").value = s.name === "(sem nome)" ? "" : s.name;
      el("type").value = String(s.type || "image");
      el("url").value = s.url;
      el("tags").value = (item.tags && Array.isArray(item.tags)) ? item.tags.join(",") : (item.tags || "");
      el("json").value = pretty(item);
      updatePreview();
      setBox("res", true, { ok:true, loaded:true });
    }

    function newItem(){
      el("id").value = "";
      el("name").value = "";
      el("type").value = "image";
      el("url").value = "";
      el("tags").value = "";
      el("json").value = pretty({
        name: "Novo item",
        type: "image",
        url: "",
        tags: ["oficial"]
      });
      updatePreview();
      setBox("res", true, { ok:true, new:true });
    }

    async function listMedia(){
      let r = await ADMIN.fetchJSON(FN_LIST + "?limit=200", { method:"GET" });
      if (r.res.status === 405){
        r = await ADMIN.fetchJSON(FN_LIST, { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ limit:200 }) });
      }
      const ok = r.res.ok && (r.data?.ok !== false);
      const list = ADMIN.normalizeList(r.data);
      return { ok, status:r.res.status, raw:r.data, list };
    }

    async function upsertMedia(payload){
      const r = await ADMIN.fetchJSON(FN_UPSERT, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify(payload)
      });
      return { ok: r.res.ok && (r.data?.ok !== false), status:r.res.status, raw:r.data };
    }

    async function deleteMedia(id){
      const r = await ADMIN.fetchJSON(FN_DELETE, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ id })
      });
      return { ok: r.res.ok && (r.data?.ok !== false), status:r.res.status, raw:r.data };
    }

    el("btnLogout").onclick = ()=>ADMIN.logout();
    el("btnNew").onclick = ()=>newItem();

    el("type").onchange = updatePreview;
    el("url").oninput = updatePreview;

    el("btnLoad").onclick = async ()=>{
      setBox("diag", true, { ok:true, loading:true });
      const r = await listMedia();
      lastList = filterList(r.list, el("q").value);
      renderTable(lastList);
      setBox("diag", r.ok, { ok:r.ok, status:r.status, count:lastList.length, raw:r.raw });
    };

    el("btnExport").onclick = ()=>{
      const blob = new Blob([pretty(lastList)], {type:"application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `media_${new Date().toISOString().slice(0,19).replaceAll(":","-")}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    };

    el("btnSave").onclick = async ()=>{
      let obj;
      try{ obj = JSON.parse(el("json").value || "{}"); }
      catch{ setBox("res", false, { ok:false, error:"invalid_json" }); return; }

      const id = (el("id").value || "").trim();
      const name = (el("name").value || "").trim();
      const type = el("type").value;
      const url = (el("url").value || "").trim();
      const tags = (el("tags").value || "").split(",").map(s=>s.trim()).filter(Boolean);

      if (id) obj.id = obj.id ?? id;
      if (name) obj.name = obj.name ?? name;
      obj.type = obj.type ?? type;
      obj.url = obj.url ?? url;
      if (tags.length) obj.tags = obj.tags ?? tags;

      setBox("res", true, { ok:true, saving:true });
      const r = await upsertMedia(obj);
      setBox("res", r.ok, { ok:r.ok, status:r.status, raw:r.raw });
      if (r.ok){ updatePreview(); el("btnLoad").click(); }
    };

    el("btnDelete").onclick = async ()=>{
      const id = (el("id").value || "").trim();
      if (!id){ setBox("res", false, { ok:false, error:"missing_id" }); return; }
      setBox("res", true, { ok:true, deleting:true, id });
      const r = await deleteMedia(id);
      setBox("res", r.ok, { ok:r.ok, status:r.status, raw:r.raw });
      if (r.ok){ newItem(); el("btnLoad").click(); }
    };

    // init
    newItem();
  </script>
</body>
</html>
