<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ConSySencI.A ‚Äî Biblioteca de M√≠dia (links)</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{--bg:#05080a;--card:#071014cc;--line:#0f2a22;--txt:#e9fff6;--mut:#9bd8c2;--g:#22ff9a;--bad:#ff4d6d;--r:22px;}
    *{box-sizing:border-box}
    body{margin:0;color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1100px 650px at 20% -10%, rgba(34,255,154,.18), transparent 60%),
                  radial-gradient(850px 600px at 110% 10%, rgba(15,226,138,.14), transparent 55%),
                  linear-gradient(180deg,#030607,#050a0c 55%,#040809);
      min-height:100vh;}
    .wrap{max-width:1100px;margin:0 auto;padding:22px 16px 70px}
    .top{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .btn{appearance:none;border:1px solid rgba(34,255,154,.35);background:linear-gradient(180deg, rgba(34,255,154,.10), rgba(34,255,154,.03));
      color:var(--txt);padding:10px 14px;border-radius:18px;cursor:pointer;font-weight:650}
    .btn:hover{border-color:rgba(34,255,154,.6)}
    .btn.ghost{background:transparent}
    .btn.bad{border-color:rgba(255,77,109,.35); background:linear-gradient(180deg, rgba(255,77,109,.08), rgba(255,77,109,.02))}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns: 420px 1fr}}
    .card{padding:16px;border-radius:var(--r);border:1px solid rgba(34,255,154,.16);background:linear-gradient(180deg, rgba(7,16,20,.78), rgba(7,16,20,.52));}
    .label{font-size:12px;color:var(--mut);margin:10px 0 6px}
    .input,.sel,textarea{
      width:100%;padding:11px 12px;border-radius:16px;border:1px solid rgba(34,255,154,.22);
      background:rgba(0,0,0,.26);color:var(--txt);outline:none
    }
    .input:focus,.sel:focus,textarea:focus{border-color:rgba(34,255,154,.55)}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .msg{margin-top:12px;padding:12px 14px;border-radius:16px;border:1px solid rgba(34,255,154,.18);background:rgba(0,0,0,.20);color:var(--mut);min-height:44px;overflow:auto}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(34,255,154,.10);vertical-align:top}
    th{color:var(--mut);font-weight:700;text-align:left}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .badtxt{color:var(--bad)}
    a{color:var(--g)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>üñºÔ∏è ConSySencI.A ‚Äî Biblioteca de M√≠dia (links)</h1>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn ghost" onclick="location.href='index.html'">Painel</button>
        <button class="btn" id="refreshBtn">Atualizar</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <b>Cadastrar / Editar</b>
          <button class="btn bad" id="clearBtn">Limpar</button>
        </div>

        <div class="label">Alias (ex: catalogo_geral)</div>
        <input class="input mono" id="alias" placeholder="catalogo_geral" />

        <div class="label">Tipo</div>
        <select class="sel mono" id="kind">
          <option value="image">image</option>
          <option value="link">link</option>
          <option value="file">file</option>
        </select>

        <div class="label">URL p√∫blica</div>
        <input class="input mono" id="url" placeholder="https://..." />

        <div class="label">Descri√ß√£o (opcional)</div>
        <textarea id="description" placeholder="ex: Cat√°logo geral ‚Äî vers√£o fevereiro"></textarea>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="saveBtn">Salvar</button>
          <button class="btn ghost" id="deleteBtn">Excluir</button>
        </div>

        <div class="msg mono" id="out">Pronto.</div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <b>Itens</b>
          <div class="row">
            <input class="input mono" id="q" placeholder="buscar‚Ä¶" style="width:220px">
            <button class="btn ghost" id="searchBtn">Buscar</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Alias</th>
              <th>Tipo</th>
              <th>URL</th>
              <th>Descri√ß√£o</th>
              <th style="width:120px">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
<script src="/admin/boot.js"></script>
<script>
  const LS_KEY = "CONSYSENCIA_ADMIN_TOKEN_V1";

  function token(){ return (localStorage.getItem(LS_KEY)||"").trim(); }
  function out(msg, ok=true){
    const el = document.getElementById("out");
    el.textContent = msg;
    el.className = "msg mono " + (ok ? "" : "badtxt");
  }

  async function api(path, body){
    const t = token();
    const res = await fetch(path, {
      method:"POST",
      headers:{
        "content-type":"application/json",
        "authorization": t ? `Bearer ${t}` : ""
      },
      body: JSON.stringify(body||{})
    });
    const txt = await res.text();
    let j=null;
    try{ j = JSON.parse(txt); } catch(e){ j = { ok:false, error:"non_json", details: txt.slice(0,900) }; }
    return { ok: res.ok, status: res.status, j };
  }

  function esc(s){ return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function fillForm(it){
    document.getElementById("alias").value = it.alias || "";
    document.getElementById("kind").value = it.kind || "image";
    document.getElementById("url").value = it.url || "";
    document.getElementById("description").value = it.description || "";
  }

  function clearForm(){
    fillForm({ alias:"", kind:"image", url:"", description:"" });
  }

  function render(items){
    const tb = document.getElementById("tbody");
    tb.innerHTML = "";
    for(const it of (items||[])){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono"><b>${esc(it.alias)}</b></td>
        <td class="mono">${esc(it.kind)}</td>
        <td class="mono">${it.url ? `<a href="${esc(it.url)}" target="_blank" rel="noreferrer">abrir</a>` : ""}</td>
        <td>${esc(it.description||"")}</td>
        <td>
          <button class="btn ghost" data-act="edit">Editar</button>
          <button class="btn bad" data-act="del">Excluir</button>
        </td>
      `;
      tr.querySelector('[data-act="edit"]').onclick = () => { fillForm(it); out("Editando: " + it.alias); };
      tr.querySelector('[data-act="del"]').onclick = async () => { await del(it.alias); };
      tb.appendChild(tr);
    }
  }

  async function refresh(){
    if(!token()){ out("Sem token. Volte ao /admin/ e cole seu ADMIN_TOKEN.", false); return; }
    out("Carregando‚Ä¶");
    const q = (document.getElementById("q").value||"").trim();
    const r = await api("/.netlify/functions/media_list", { q });
    if(r.ok && r.j && r.j.ok){
      render(r.j.items || []);
      out("OK ‚úÖ itens=" + (r.j.items||[]).length);
    } else {
      out("Erro ‚ùå " + JSON.stringify(r.j), false);
    }
  }

  async function save(){
    if(!token()){ out("Sem token.", false); return; }
    const alias = (document.getElementById("alias").value||"").trim();
    const kind  = (document.getElementById("kind").value||"image").trim();
    const url   = (document.getElementById("url").value||"").trim();
    const description = (document.getElementById("description").value||"").trim();

    if(!alias){ out("Alias √© obrigat√≥rio.", false); return; }
    if(!url){ out("URL √© obrigat√≥ria.", false); return; }

    out("Salvando‚Ä¶");
    const r = await api("/.netlify/functions/media_upsert", { alias, kind, url, description });
    if(r.ok && r.j && r.j.ok){
      out("Salvo ‚úÖ");
      await refresh();
    } else {
      out("Erro ‚ùå " + JSON.stringify(r.j), false);
    }
  }

  async function del(alias){
    if(!token()){ out("Sem token.", false); return; }
    if(!alias){ out("Selecione um item ou digite um alias.", false); return; }
    out("Excluindo‚Ä¶");
    const r = await api("/.netlify/functions/media_delete", { alias });
    if(r.ok && r.j && r.j.ok){
      out("Exclu√≠do ‚úÖ " + alias);
      clearForm();
      await refresh();
    } else {
      out("Erro ‚ùå " + JSON.stringify(r.j), false);
    }
  }

  document.getElementById("refreshBtn").onclick = refresh;
  document.getElementById("searchBtn").onclick = refresh;
  document.getElementById("saveBtn").onclick = save;
  document.getElementById("deleteBtn").onclick = () => del((document.getElementById("alias").value||"").trim());
  document.getElementById("clearBtn").onclick = () => { clearForm(); out("Limpo."); };

  refresh();
</script>
</body>
</html>
