<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ConSySencI.A ‚Äî Biblioteca de M√≠dia (links)</title>
  <style>
    :root{
      --bg:#070b0f; --txt:#e9f1f0; --mut:#93a7a4;
      --green:#21ff8a; --red:#ff4d6d; --line:#14302a;
      --card: rgba(10,18,22,.80);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1000px 700px at 25% 20%, rgba(33,255,138,.10), transparent 60%),
        radial-gradient(900px 600px at 75% 35%, rgba(0,201,120,.08), transparent 55%),
        linear-gradient(180deg, var(--bg), #04070a 60%, #030507);
      min-height:100vh;
      padding:16px;
    }
    .wrap{max-width:1100px;margin:0 auto;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:8px 0 14px;
      flex-wrap:wrap;
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(33,255,138,.35);
      background: linear-gradient(180deg, rgba(6,28,22,.9), rgba(4,16,13,.85));
      color:var(--txt);
      padding:12px 14px;
      border-radius:16px;
      font-weight:800;
      cursor:pointer;
      transition:.15s transform ease, .15s opacity ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{transform: translateY(-1px);}
    .btn:active{transform: translateY(0px); opacity:.9;}
    .btn.secondary{
      border-color: rgba(20,48,42,.9);
      background: rgba(3,7,9,.55);
      color: var(--green);
    }
    .btn.danger{
      border-color: rgba(255,77,109,.45);
      background: rgba(30,10,14,.65);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(20,48,42,.9);
      background: rgba(3,7,9,.55);
      color:var(--mut);
      font-size:12px;
    }
    .ok{color:var(--green)} .bad{color:var(--red)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

    .card{
      background: linear-gradient(180deg, rgba(10,18,22,.82), rgba(7,16,15,.68));
      border:1px solid rgba(20,48,42,.85);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
      margin:0 0 12px;
    }
    .input, .select, textarea{
      padding:12px 14px;border-radius:14px;
      border:1px solid rgba(20,48,42,.9);
      background: rgba(3,7,9,.75);
      color:var(--txt);
      outline:none;
      font-size:14px;
      width:100%;
    }
    textarea{min-height:110px; resize:vertical}
    .input::placeholder, textarea::placeholder{color:#7f9893}
    .msg{
      margin-top:10px;
      padding:12px;border-radius:14px;
      border:1px solid rgba(20,48,42,.9);
      background: rgba(3,7,9,.55);
      color:var(--mut);
      font-size:13px;
      white-space:pre-wrap;
      line-height:1.45;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 920px){
      .grid{grid-template-columns: 1fr 1.15fr;}
    }

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{color:var(--mut);font-weight:800;text-align:left;font-size:12px;padding:0 10px}
    td{
      background: rgba(3,7,9,.55);
      border:1px solid rgba(20,48,42,.75);
      padding:10px;
      font-size:13px;
      vertical-align:top;
    }
    tr td:first-child{border-radius:14px 0 0 14px}
    tr td:last-child{border-radius:0 14px 14px 0}
    a{color:var(--green);text-decoration:none;border-bottom:1px dashed rgba(33,255,138,.35)}
    .small{font-size:12px;color:var(--mut);line-height:1.45}
    .kbd{
      display:inline-block;
      padding:2px 8px;
      border:1px solid rgba(20,48,42,.85);
      border-radius:999px;
      background: rgba(3,7,9,.55);
      color: var(--mut);
      font-size:12px;
      margin-left:6px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <h1>üñºÔ∏è ConSySencI.A ‚Äî Biblioteca de M√≠dia (links)</h1>
        <a class="btn secondary" href="/admin/">Painel</a>
        <button class="btn" onclick="refresh()">üîÑ Atualizar</button>
      </div>
      <div class="row">
        <span class="pill">Status: <span id="status" class="mono">‚Äî</span></span>
        <span class="pill">Token: <span id="tokenState" class="mono">vazio</span></span>
      </div>
    </header>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div style="flex:1;min-width:260px;">
          <div class="small">Token Admin (salvo no navegador)</div>
          <input id="token" class="input mono" placeholder="Cole o token admin (sem Bearer)" autocomplete="off">
        </div>
        <div class="row">
          <button class="btn" onclick="saveToken()">Salvar</button>
          <button class="btn danger" onclick="clearToken()">Limpar</button>
          <button class="btn" onclick="ping()">Testar</button>
        </div>
      </div>
      <div id="err" class="msg" style="display:none"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 6px;font-size:16px">Cadastrar / Editar</h2>
        <div class="small">
          Use um <b>alias</b> est√°vel (ex: <span class="mono">catalogo_geral</span>, <span class="mono">pix_qr</span>, <span class="mono">banner_nivel1</span>).
          Depois a IA pode responder com ‚Äúenvio por link‚Äù.
        </div>

        <div style="height:10px"></div>

        <label class="small">Alias <span class="kbd">chave</span></label>
        <input id="alias" class="input mono" placeholder="ex: catalogo_geral">

        <div style="height:10px"></div>

        <label class="small">Tipo</label>
        <select id="kind" class="select">
          <option value="image">image</option>
          <option value="link">link</option>
          <option value="pdf">pdf</option>
          <option value="video">video</option>
        </select>

        <div style="height:10px"></div>

        <label class="small">URL p√∫blica</label>
        <input id="url" class="input mono" placeholder="https://...">

        <div style="height:10px"></div>

        <label class="small">Descri√ß√£o (opcional)</label>
        <textarea id="desc" placeholder="ex: Cat√°logo geral ‚Äî vers√£o fevereiro"></textarea>

        <div style="height:12px"></div>

        <div class="row">
          <button class="btn" onclick="save()">Salvar</button>
          <button class="btn secondary" onclick="clearForm()">Limpar</button>
        </div>

        <div class="small" style="margin-top:10px">
          ‚ö†Ô∏è Se aparecer <span class="mono">unauthorized</span>, seu token do painel n√£o bate com o token do backend.
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 6px;font-size:16px">Itens</h2>
        <div class="row" style="margin-bottom:10px">
          <input id="q" class="input" placeholder="Buscar (alias / descri√ß√£o)‚Ä¶">
          <button class="btn" onclick="refresh()">Buscar</button>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:210px">Alias</th>
              <th style="width:90px">Tipo</th>
              <th>URL / Descri√ß√£o</th>
              <th style="width:170px">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="small">
          Clique em ‚ÄúEditar‚Äù para carregar no formul√°rio. ‚ÄúExcluir‚Äù remove do banco via function.
        </div>
      </div>
    </div>
  </div>

  <script>
    const TOKEN_KEY = "consysencia_admin_token";

    function getToken(){ return localStorage.getItem(TOKEN_KEY) || ""; }
    function setToken(t){ localStorage.setItem(TOKEN_KEY, t); }
    function delToken(){ localStorage.removeItem(TOKEN_KEY); }

    function setStatus(text, ok){
      const s = document.getElementById("status");
      s.textContent = text || "‚Äî";
      s.className = "mono " + (ok ? "ok" : (ok===false ? "bad" : ""));
      const t = getToken();
      document.getElementById("tokenState").textContent = t ? (t.slice(0,6)+"‚Ä¶"+t.slice(-4)) : "vazio";
    }

    function showErr(obj){
      const el = document.getElementById("err");
      if(!obj){ el.style.display="none"; el.textContent=""; return; }
      el.style.display="block";
      el.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }

    async function api(path, body){
      const r = await fetch(path, {
        method: "POST",
        headers: {
          "content-type":"application/json",
          "authorization":"Bearer " + getToken()
        },
        body: JSON.stringify(body || {})
      });
      const j = await r.json().catch(()=>({ok:false,error:"invalid_json"}));
      return { status: r.status, j };
    }

    function saveToken(){
      const raw = (document.getElementById("token").value || "").trim();
      const t = raw.replace(/^Bearer\s+/i,"").trim();
      if(!t){ setStatus("token vazio", false); return; }
      setToken(t);
      setStatus("token salvo ‚úÖ", true);
      showErr(null);
      ping();
    }

    function clearToken(){
      delToken();
      document.getElementById("token").value = "";
      setStatus("token limpo", false);
      showErr(null);
    }

    async function ping(){
      setStatus("testando‚Ä¶", null);
      const out = await api("/.netlify/functions/admin_ping", {});
      if(out.j && out.j.ok){
        setStatus("ok ‚úÖ", true);
        showErr(null);
      }else{
        setStatus("falhou ‚ùå", false);
        showErr(out.j);
      }
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function clearForm(){
      document.getElementById("alias").value = "";
      document.getElementById("kind").value = "image";
      document.getElementById("url").value = "";
      document.getElementById("desc").value = "";
    }

    function loadToForm(it){
      document.getElementById("alias").value = it.alias || "";
      document.getElementById("kind").value = it.kind || "image";
      document.getElementById("url").value = it.url || "";
      document.getElementById("desc").value = it.description || "";
      window.scrollTo({top:0,behavior:"smooth"});
    }

    async function save(){
      showErr(null);
      const alias = (document.getElementById("alias").value || "").trim();
      const kind  = (document.getElementById("kind").value || "").trim();
      const url   = (document.getElementById("url").value || "").trim();
      const desc  = (document.getElementById("desc").value || "").trim();

      if(!alias){ setStatus("alias obrigat√≥rio", false); return; }
      if(!url){ setStatus("url obrigat√≥ria", false); return; }

      setStatus("salvando‚Ä¶", null);
      const out = await api("/.netlify/functions/media_upsert", {
        alias, kind, url, description: desc
      });

      if(out.j && out.j.ok){
        setStatus("salvo ‚úÖ", true);
        clearForm();
        refresh();
      }else{
        setStatus("erro ‚ùå", false);
        showErr(out.j);
      }
    }

    async function del(alias){
      if(!confirm("Excluir '" + alias + "' ?")) return;
      setStatus("excluindo‚Ä¶", null);
      const out = await api("/.netlify/functions/media_delete", { alias });
      if(out.j && out.j.ok){
        setStatus("exclu√≠do ‚úÖ", true);
        refresh();
      }else{
        setStatus("erro ‚ùå", false);
        showErr(out.j);
      }
    }

    function render(items){
      const tb = document.getElementById("tbody");
      tb.innerHTML = "";
      const q = (document.getElementById("q").value || "").trim().toLowerCase();

      const filtered = (items || []).filter(it=>{
        if(!q) return true;
        const hay = [(it.alias||""),(it.kind||""),(it.url||""),(it.description||"")].join(" ").toLowerCase();
        return hay.includes(q);
      });

      for(const it of filtered){
        const alias = escapeHtml(it.alias || "");
        const kind = escapeHtml(it.kind || "");
        const url = escapeHtml(it.url || "");
        const desc = escapeHtml(it.description || "");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono"><b>${alias}</b></td>
          <td class="mono">${kind}</td>
          <td>
            <div><a href="${url}" target="_blank" rel="noreferrer">${url}</a></div>
            <div class="small">${desc || ""}</div>
          </td>
          <td>
            <div class="row">
              <button class="btn secondary" onclick='editItem(${JSON.stringify(it)})'>Editar</button>
              <button class="btn danger" onclick="del('${alias}')">Excluir</button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      }

      if(filtered.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="mono">Sem itens (ou filtro muito restrito).</td>`;
        tb.appendChild(tr);
      }
    }

    function editItem(it){ loadToForm(it); }

    async function refresh(){
      setStatus("carregando‚Ä¶", null);
      showErr(null);

      const out = await api("/.netlify/functions/media_list", { limit: 200 });
      if(out.j && out.j.ok){
        setStatus("ok ‚úÖ", true);
        render(out.j.items || []);
      }else{
        setStatus("erro ‚ùå", false);
        showErr(out.j);
        render([]);
      }
    }

    (function init(){
      const t = getToken();
      if(t) document.getElementById("token").value = t;
      document.getElementById("tokenState").textContent = t ? (t.slice(0,6)+"‚Ä¶"+t.slice(-4)) : "vazio";
      setStatus("‚Äî", null);
      refresh();
    })();
  </script>
</body>
</html>
