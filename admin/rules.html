<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ConSySencI.A — Regras</title>
  <meta name="color-scheme" content="dark"/>
  <style>
    :root{--bg:#050a08;--bg2:#07120d;--line:rgba(0,255,163,.18);--line2:rgba(0,255,163,.10);--txt:rgba(236,255,247,.92);--muted:rgba(236,255,247,.65);--muted2:rgba(236,255,247,.45);--green:#00ffa3;--red:#ff4d6d;--shadow:0 18px 50px rgba(0,0,0,.55);--r:22px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--txt);
      background:radial-gradient(900px 520px at 20% 15%, rgba(0,255,163,.16), transparent 55%),
      radial-gradient(700px 420px at 75% 30%, rgba(0,255,163,.10), transparent 60%),
      linear-gradient(180deg,var(--bg),var(--bg2));}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 70px}
    .top{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:14px;border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg,rgba(0,255,163,.08),rgba(0,0,0,.18));box-shadow:var(--shadow);position:sticky;top:10px;z-index:10;backdrop-filter:blur(10px);}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .dot{width:12px;height:12px;border-radius:999px;background:var(--green);box-shadow:0 0 0 6px rgba(0,255,163,.12),0 0 24px rgba(0,255,163,.35)}
    h1{margin:0;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{margin:4px 0 0;color:var(--muted);font-size:13px}
    .btn{border:1px solid var(--line);background:rgba(0,255,163,.06);color:var(--txt);padding:10px 12px;border-radius:999px;font-weight:650;font-size:13px;cursor:pointer}
    .btn:hover{border-color:rgba(0,255,163,.35);background:rgba(0,255,163,.10)}
    .btn.ghost{background:rgba(0,0,0,.22)}
    .btn.danger{border-color:rgba(255,77,109,.35);background:rgba(255,77,109,.10)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:980px){.grid{grid-template-columns:1.05fr .95fr}}
    .card{border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.10))}
    .head{padding:16px;border-bottom:1px solid var(--line2);background:linear-gradient(180deg,rgba(0,255,163,.06),transparent)}
    .head h2{margin:0;font-size:16px}
    .head p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .body{padding:16px}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:12px}
    input,select,textarea{width:100%;padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(0,0,0,.35);color:var(--txt);outline:none;font-size:14px}
    textarea{min-height:170px;resize:vertical;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{flex:1 1 220px;min-width:200px}
    .result{margin-top:12px;padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(0,0,0,.25);white-space:pre;overflow:auto;max-height:280px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;line-height:1.35}
    .ok{border-color:rgba(0,255,163,.35);background:rgba(0,255,163,.06)}
    .err{border-color:rgba(255,77,109,.35);background:rgba(255,77,109,.08);color:rgba(255,240,245,.92)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line2);border-radius:16px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid rgba(0,255,163,.08);font-size:12.5px;vertical-align:top}
    th{color:var(--muted);text-align:left;background:rgba(0,255,163,.04)}
    .small{font-size:12px;color:var(--muted2)}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line2);background:rgba(0,0,0,.20);color:var(--muted);font-size:12px}
    .click{cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div style="min-width:0">
          <h1>Regras</h1>
          <p class="sub">rules_list • rules_upsert • rules_delete</p>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <a class="btn ghost" href="/admin/index.html">Voltar</a>
        <a class="btn ghost" href="/admin/events.html">Eventos</a>
        <a class="btn ghost" href="/admin/media.html">Mídia</a>
        <button class="btn danger" id="btnLogout" type="button">Sair</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="head">
          <h2>Lista</h2>
          <p>Clique em uma regra para carregar no editor. Filtro busca em todo o JSON.</p>
        </div>
        <div class="body">
          <div class="row">
            <div class="field">
              <label>Filtro</label>
              <input id="q" placeholder="Ex: nome, keyword, contains, status..." autocomplete="off" spellcheck="false"/>
            </div>
            <button class="btn" id="btnLoad" type="button">Carregar</button>
            <button class="btn ghost" id="btnExport" type="button">Export JSON</button>
          </div>

          <div id="diag" class="result ok">{ "ok": true, "info": "Carregue para ver as regras." }</div>

          <div style="margin-top:12px;overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="width:110px">id</th>
                  <th style="width:220px">nome</th>
                  <th style="width:120px">enabled</th>
                  <th>resumo</th>
                </tr>
              </thead>
              <tbody id="tb">
                <tr><td colspan="4" class="small">Sem dados ainda.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="head">
          <h2>Editor</h2>
          <p>Edite o JSON livremente e clique em <b>Salvar (Upsert)</b>. Para deletar, precisa de id.</p>
        </div>
        <div class="body">
          <div class="row">
            <div class="field">
              <label>ID (opcional, para editar/deletar)</label>
              <input id="id" placeholder="Ex: 123 / uuid / slug..." autocomplete="off" spellcheck="false"/>
            </div>
            <div class="field">
              <label>Nome (ajuda no resumo)</label>
              <input id="name" placeholder="Ex: Regra Boas-vindas" autocomplete="off" spellcheck="false"/>
            </div>
            <div class="field">
              <label>Enabled</label>
              <select id="enabled">
                <option value="true" selected>true</option>
                <option value="false">false</option>
              </select>
            </div>
          </div>

          <label style="margin-top:10px">JSON da regra</label>
          <textarea id="json" spellcheck="false"></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnSave" type="button">Salvar (Upsert)</button>
            <button class="btn ghost" id="btnNew" type="button">Nova regra</button>
            <button class="btn danger" id="btnDelete" type="button">Deletar</button>
          </div>

          <div id="res" class="result ok">{ "ok": true, "info": "Pronto." }</div>
        </div>
      </section>
    </div>
  </div>

  <script src="/admin/boot.js"></script>
  <script>
    const FN_LIST   = "/.netlify/functions/rules_list";
    const FN_UPSERT = "/.netlify/functions/rules_upsert";
    const FN_DELETE = "/.netlify/functions/rules_delete";

    const el = (id)=>document.getElementById(id);
    const pretty = (x)=>ADMIN.pretty(x);
    let lastList = [];

    function setBox(id, ok, obj){
      const box = el(id);
      box.className = "result " + (ok ? "ok":"err");
      box.textContent = pretty(obj);
    }

    function escapeHTML(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function filterList(list, query){
      const q = (query || "").trim().toLowerCase();
      if (!q) return list;
      return list.filter(r => JSON.stringify(r).toLowerCase().includes(q));
    }

    function summarize(rule){
      const name = rule.name || rule.title || rule.rule_name || "";
      const enabled = (rule.enabled ?? rule.is_enabled ?? true);
      const blob = JSON.stringify(rule);
      const res = blob.length > 180 ? blob.slice(0,180) + "…" : blob;
      return { name, enabled, res };
    }

    function renderTable(list){
      const tb = el("tb");
      tb.innerHTML = "";
      if (!list.length){
        tb.innerHTML = `<tr><td colspan="4" class="small">Sem regras.</td></tr>`;
        return;
      }
      list.forEach((r, idx)=>{
        const id = r.id ?? r.rule_id ?? r.key ?? "";
        const s = summarize(r);
        const tr = document.createElement("tr");
        tr.className = "click";
        tr.innerHTML = `
          <td class="small">${escapeHTML(id || ("#" + (idx+1)))}</td>
          <td>${escapeHTML(s.name || "(sem nome)")}</td>
          <td><span class="tag">${escapeHTML(String(s.enabled))}</span></td>
          <td class="small">${escapeHTML(s.res)}</td>
        `;
        tr.onclick = ()=>loadIntoEditor(r);
        tb.appendChild(tr);
      });
    }

    function loadIntoEditor(rule){
      el("id").value = rule.id ?? rule.rule_id ?? rule.key ?? "";
      el("name").value = rule.name ?? rule.title ?? rule.rule_name ?? "";
      el("enabled").value = String(rule.enabled ?? rule.is_enabled ?? true);
      el("json").value = pretty(rule);
      setBox("res", true, { ok:true, loaded:true });
    }

    function newRule(){
      el("id").value = "";
      el("name").value = "";
      el("enabled").value = "true";
      el("json").value = pretty({
        name: "Nova Regra",
        enabled: true,
        match: { contains: "ATIVAR" },
        response: { text: "Olá! Seu acesso foi ativado ✅" }
      });
      setBox("res", true, { ok:true, new:true });
    }

    async function listRules(){
      let r = await ADMIN.fetchJSON(FN_LIST + "?limit=200", { method:"GET" });
      if (r.res.status === 405){
        r = await ADMIN.fetchJSON(FN_LIST, { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ limit:200 }) });
      }
      const ok = r.res.ok && (r.data?.ok !== false);
      const list = ADMIN.normalizeList(r.data);
      return { ok, status:r.res.status, raw:r.data, list };
    }

    async function upsertRule(payload){
      const r = await ADMIN.fetchJSON(FN_UPSERT, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify(payload)
      });
      return { ok: r.res.ok && (r.data?.ok !== false), status:r.res.status, raw:r.data };
    }

    async function deleteRule(id){
      const r = await ADMIN.fetchJSON(FN_DELETE, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ id })
      });
      return { ok: r.res.ok && (r.data?.ok !== false), status:r.res.status, raw:r.data };
    }

    el("btnLogout").onclick = ()=>ADMIN.logout();
    el("btnNew").onclick = ()=>newRule();

    el("btnLoad").onclick = async ()=>{
      setBox("diag", true, { ok:true, loading:true });
      const r = await listRules();
      lastList = filterList(r.list, el("q").value);
      renderTable(lastList);
      setBox("diag", r.ok, { ok:r.ok, status:r.status, count:lastList.length, raw:r.raw });
    };

    el("btnExport").onclick = ()=>{
      const blob = new Blob([pretty(lastList)], {type:"application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `rules_${new Date().toISOString().slice(0,19).replaceAll(":","-")}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    };

    el("btnSave").onclick = async ()=>{
      let obj;
      try{ obj = JSON.parse(el("json").value || "{}"); }
      catch{ setBox("res", false, { ok:false, error:"invalid_json" }); return; }

      const id = (el("id").value || "").trim();
      const name = (el("name").value || "").trim();
      const enabled = (el("enabled").value === "true");

      // injeta campos comuns sem quebrar estruturas livres
      if (id) obj.id = obj.id ?? id;
      if (name) obj.name = obj.name ?? name;
      obj.enabled = obj.enabled ?? enabled;

      setBox("res", true, { ok:true, saving:true });
      const r = await upsertRule(obj);
      setBox("res", r.ok, { ok:r.ok, status:r.status, raw:r.raw });

      // recarrega lista
      if (r.ok) el("btnLoad").click();
    };

    el("btnDelete").onclick = async ()=>{
      const id = (el("id").value || "").trim();
      if (!id){ setBox("res", false, { ok:false, error:"missing_id" }); return; }
      setBox("res", true, { ok:true, deleting:true, id });
      const r = await deleteRule(id);
      setBox("res", r.ok, { ok:r.ok, status:r.status, raw:r.raw });
      if (r.ok){ newRule(); el("btnLoad").click(); }
    };

    // init
    newRule();
  </script>
</body>
</html>
