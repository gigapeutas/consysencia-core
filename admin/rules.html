<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ConSySencI.A â€” Regras (gatilhos / respostas)</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{--bg:#05080a;--card:#071014cc;--line:#0f2a22;--txt:#e9fff6;--mut:#9bd8c2;--g:#22ff9a;--bad:#ff4d6d;--r:22px;}
    *{box-sizing:border-box}
    body{margin:0;color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1100px 650px at 20% -10%, rgba(34,255,154,.18), transparent 60%),
                  radial-gradient(850px 600px at 110% 10%, rgba(15,226,138,.14), transparent 55%),
                  linear-gradient(180deg,#030607,#050a0c 55%,#040809);
      min-height:100vh;}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 16px 70px}
    .top{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .btn{appearance:none;border:1px solid rgba(34,255,154,.35);background:linear-gradient(180deg, rgba(34,255,154,.10), rgba(34,255,154,.03));
      color:var(--txt);padding:10px 14px;border-radius:18px;cursor:pointer;font-weight:650}
    .btn:hover{border-color:rgba(34,255,154,.6)}
    .btn.ghost{background:transparent}
    .btn.bad{border-color:rgba(255,77,109,.35); background:linear-gradient(180deg, rgba(255,77,109,.08), rgba(255,77,109,.02))}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:980px){.grid{grid-template-columns: 460px 1fr}}
    .card{padding:16px;border-radius:var(--r);border:1px solid rgba(34,255,154,.16);background:linear-gradient(180deg, rgba(7,16,20,.78), rgba(7,16,20,.52));}
    .label{font-size:12px;color:var(--mut);margin:10px 0 6px}
    .input,.sel,textarea{
      width:100%;padding:11px 12px;border-radius:16px;border:1px solid rgba(34,255,154,.22);
      background:rgba(0,0,0,.26);color:var(--txt);outline:none
    }
    .input:focus,.sel:focus,textarea:focus{border-color:rgba(34,255,154,.55)}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .msg{margin-top:12px;padding:12px 14px;border-radius:16px;border:1px solid rgba(34,255,154,.18);background:rgba(0,0,0,.20);color:var(--mut);min-height:44px;overflow:auto}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(34,255,154,.10);vertical-align:top}
    th{color:var(--mut);font-weight:700;text-align:left}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .badtxt{color:var(--bad)}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(34,255,154,.22);background:rgba(0,0,0,.22);color:var(--mut)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>ðŸ§© ConSySencI.A â€” Regras (gatilhos / respostas)</h1>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn ghost" onclick="location.href='index.html'">Painel</button>
        <button class="btn" id="refreshBtn">Atualizar</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <b>Criar / Editar Regra</b>
          <button class="btn bad" id="clearBtn">Limpar</button>
        </div>

        <div class="label">ID (auto)</div>
        <input class="input mono" id="id" placeholder="(deixe vazio para criar novo)" />

        <div class="row">
          <div style="flex:1">
            <div class="label">Ativa?</div>
            <select class="sel mono" id="is_active">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="label">Prioridade</div>
            <input class="input mono" id="priority" value="100" />
          </div>
        </div>

        <div class="label">match_kind</div>
        <select class="sel mono" id="match_kind">
          <option value="equals">equals</option>
          <option value="contains">contains</option>
          <option value="starts_with">starts_with</option>
          <option value="regex">regex</option>
        </select>

        <div class="label">match_text (gatilho)</div>
        <input class="input mono" id="match_text" placeholder="pix" />

        <div class="label">match_group (opcional)</div>
        <input class="input mono" id="match_group" placeholder="nome do grupo (se quiser travar por grupo)" />

        <div class="label">match_sender (opcional)</div>
        <input class="input mono" id="match_sender" placeholder="nome do sender (se quiser travar por pessoa)" />

        <div class="label">reply_text (resposta)</div>
        <textarea id="reply_text" placeholder="Texto que o bot vai enviarâ€¦"></textarea>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="saveBtn">Salvar</button>
          <button class="btn ghost" id="toggleBtn">Ativar/Desativar</button>
          <button class="btn bad" id="deleteBtn">Excluir</button>
        </div>

        <div class="msg mono" id="out">Pronto.</div>

        <div class="label">Teste rÃ¡pido (simula entrada)</div>
        <div class="row">
          <input class="input mono" id="testMsg" placeholder="Digite uma mensagem (ex: pix)" style="flex:1">
          <button class="btn" id="testBtn">Testar</button>
        </div>
        <div class="msg mono" id="testOut">â€”</div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <b>Regras ativas (por prioridade)</b>
          <div class="row">
            <span class="tag">buscar</span>
            <input class="input mono" id="q" placeholder="pix / catÃ¡logo / suporteâ€¦" style="width:260px">
            <button class="btn ghost" id="searchBtn">Buscar</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Ativa</th>
              <th>Pri</th>
              <th>kind</th>
              <th>match_text</th>
              <th>preview</th>
              <th style="width:160px">AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
<script src="/admin/boot.js"></script>
<script>
  const LS_KEY = "CONSYSENCIA_ADMIN_TOKEN_V1";

  function token(){ return (localStorage.getItem(LS_KEY)||"").trim(); }
  function out(msg, ok=true){
    const el = document.getElementById("out");
    el.textContent = msg;
    el.className = "msg mono " + (ok ? "" : "badtxt");
  }
  function testOut(msg, ok=true){
    const el = document.getElementById("testOut");
    el.textContent = msg;
    el.className = "msg mono " + (ok ? "" : "badtxt");
  }

  async function api(path, body){
    const t = token();
    const res = await fetch(path, {
      method:"POST",
      headers:{
        "content-type":"application/json",
        "authorization": t ? `Bearer ${t}` : ""
      },
      body: JSON.stringify(body||{})
    });
    const txt = await res.text();
    let j=null;
    try{ j = JSON.parse(txt); } catch(e){ j = { ok:false, error:"non_json", details: txt.slice(0,900) }; }
    return { ok: res.ok, status: res.status, j };
  }

  function esc(s){ return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function fillForm(it){
    document.getElementById("id").value = it.id || "";
    document.getElementById("is_active").value = String(it.is_active ?? true);
    document.getElementById("priority").value = String(it.priority ?? 100);
    document.getElementById("match_kind").value = it.match_kind || "equals";
    document.getElementById("match_text").value = it.match_text || "";
    document.getElementById("match_group").value = it.match_group || "";
    document.getElementById("match_sender").value = it.match_sender || "";
    document.getElementById("reply_text").value = it.reply_text || it.preview || "";
  }

  function clearForm(){
    fillForm({ id:"", is_active:true, priority:100, match_kind:"equals", match_text:"", match_group:"", match_sender:"", reply_text:"" });
  }

  function getForm(){
    const id = (document.getElementById("id").value||"").trim();
    const is_active = (document.getElementById("is_active").value||"true") === "true";
    const priority = parseInt(document.getElementById("priority").value||"100",10);
    const match_kind = (document.getElementById("match_kind").value||"equals").trim();
    const match_text = (document.getElementById("match_text").value||"").trim();
    const match_group = (document.getElementById("match_group").value||"").trim();
    const match_sender = (document.getElementById("match_sender").value||"").trim();
    const reply_text = (document.getElementById("reply_text").value||"").trim();
    return { id, is_active, priority, match_kind, match_text, match_group, match_sender, reply_text };
  }

  function render(items){
    const tb = document.getElementById("tbody");
    tb.innerHTML = "";
    for(const it of (items||[])){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${it.is_active ? "âœ…" : "â€”"}</td>
        <td class="mono">${esc(it.priority)}</td>
        <td class="mono">${esc(it.match_kind)}</td>
        <td class="mono"><b>${esc(it.match_text||"")}</b></td>
        <td class="mono" style="white-space:pre-wrap;opacity:.9">${esc(it.preview||it.reply_text||"")}</td>
        <td>
          <button class="btn ghost" data-act="edit">Editar</button>
          <button class="btn bad" data-act="del">Excluir</button>
        </td>
      `;
      tr.querySelector('[data-act="edit"]').onclick = async () => {
        // carregar regra completa pelo id (se sua function listar jÃ¡ vier completa, funciona igual)
        fillForm(it);
        out("Editando: " + it.match_text);
      };
      tr.querySelector('[data-act="del"]').onclick = async () => { await del(it.id); };
      tb.appendChild(tr);
    }
  }

  async function refresh(){
    if(!token()){ out("Sem token. Volte ao /admin/ e cole seu ADMIN_TOKEN.", false); return; }
    out("Carregandoâ€¦");
    const q = (document.getElementById("q").value||"").trim();
    const r = await api("/.netlify/functions/rules_list", { q });
    if(r.ok && r.j && r.j.ok){
      render(r.j.items || []);
      out("OK âœ… regras=" + (r.j.items||[]).length);
    } else {
      out("Erro âŒ " + JSON.stringify(r.j), false);
    }
  }

  async function save(){
    if(!token()){ out("Sem token.", false); return; }
    const f = getForm();
    if(!f.match_text){ out("match_text Ã© obrigatÃ³rio.", false); return; }
    if(!f.reply_text){ out("reply_text Ã© obrigatÃ³rio.", false); return; }
    out("Salvandoâ€¦");
    const r = await api("/.netlify/functions/rules_upsert", f);
    if(r.ok && r.j && r.j.ok){
      out("Salvo âœ…");
      await refresh();
    } else {
      out("Erro âŒ " + JSON.stringify(r.j), false);
    }
  }

  async function del(id){
    if(!token()){ out("Sem token.", false); return; }
    if(!id){ out("Selecione uma regra (id).", false); return; }
    out("Excluindoâ€¦");
    const r = await api("/.netlify/functions/rules_delete", { id });
    if(r.ok && r.j && r.j.ok){
      out("ExcluÃ­do âœ…");
      clearForm();
      await refresh();
    } else {
      out("Erro âŒ " + JSON.stringify(r.j), false);
    }
  }

  async function toggleActive(){
    const f = getForm();
    if(!f.id){ out("Selecione uma regra existente (id).", false); return; }
    f.is_active = !f.is_active;
    out("Atualizandoâ€¦");
    const r = await api("/.netlify/functions/rules_upsert", f);
    if(r.ok && r.j && r.j.ok){
      out("Atualizado âœ… is_active=" + f.is_active);
      await refresh();
    } else {
      out("Erro âŒ " + JSON.stringify(r.j), false);
    }
  }

  async function testRule(){
    if(!token()){ testOut("Sem token.", false); return; }
    const message = (document.getElementById("testMsg").value||"").trim();
    testOut("Testandoâ€¦");
    const r = await api("/.netlify/functions/rules_test", { message });
    if(r.ok && r.j && r.j.ok){
      testOut("Resposta: \n" + (r.j.reply_text || "â€”"));
    } else {
      testOut("Erro âŒ " + JSON.stringify(r.j), false);
    }
  }

  document.getElementById("refreshBtn").onclick = refresh;
  document.getElementById("searchBtn").onclick = refresh;
  document.getElementById("saveBtn").onclick = save;
  document.getElementById("toggleBtn").onclick = toggleActive;
  document.getElementById("deleteBtn").onclick = () => del((document.getElementById("id").value||"").trim());
  document.getElementById("clearBtn").onclick = () => { clearForm(); out("Limpo."); };
  document.getElementById("testBtn").onclick = testRule;

  refresh();
</script>
</body>
</html>
