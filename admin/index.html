<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ConSySencI.A — Admin</title>
  <meta name="color-scheme" content="dark"/>
  <style>
    :root{
      --bg:#050a08; --bg2:#07120d;
      --line:rgba(0,255,163,.18); --line2:rgba(0,255,163,.10);
      --txt:rgba(236,255,247,.92); --muted:rgba(236,255,247,.65); --muted2:rgba(236,255,247,.45);
      --green:#00ffa3; --red:#ff4d6d; --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--txt);
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(0,255,163,.16), transparent 55%),
        radial-gradient(700px 420px at 75% 30%, rgba(0,255,163,.10), transparent 60%),
        linear-gradient(180deg,var(--bg),var(--bg2));
    }
    .wrap{max-width:1020px;margin:0 auto;padding:18px 14px 70px}
    .top{
      display:flex;justify-content:space-between;gap:12px;align-items:center;
      padding:14px 14px;border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg,rgba(0,255,163,.08),rgba(0,0,0,.18));
      box-shadow:var(--shadow); position:sticky; top:10px; z-index:10; backdrop-filter:blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .dot{width:12px;height:12px;border-radius:999px;background:var(--green);
      box-shadow:0 0 0 6px rgba(0,255,163,.12),0 0 24px rgba(0,255,163,.35)}
    h1{margin:0;font-size:20px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{margin:4px 0 0;color:var(--muted);font-size:13px}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{padding:9px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(0,0,0,.22);color:var(--muted);font-size:12px}
    .pill b{color:var(--green)}
    .btn{
      border:1px solid var(--line);background:rgba(0,255,163,.06);color:var(--txt);
      padding:10px 12px;border-radius:999px;font-weight:650;font-size:13px;cursor:pointer;
    }
    .btn:hover{border-color:rgba(0,255,163,.35);background:rgba(0,255,163,.10)}
    .btn.ghost{background:rgba(0,0,0,.22)}
    .btn.danger{border-color:rgba(255,77,109,.35);background:rgba(255,77,109,.10)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:920px){.grid{grid-template-columns:1.05fr .95fr}}
    .card{
      border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;
      background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.10));
    }
    .head{padding:16px;border-bottom:1px solid var(--line2);background:linear-gradient(180deg,rgba(0,255,163,.06),transparent)}
    .head h2{margin:0;font-size:16px}
    .head p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .body{padding:16px}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:12px}
    input{
      width:100%;padding:12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(0,0,0,.35);color:var(--txt);outline:none;font-size:14px
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{flex:1 1 260px;min-width:220px}
    .nav{
      display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px
    }
    @media(min-width:920px){.nav{grid-template-columns:repeat(3,1fr)}}
    .tile{
      display:block;text-decoration:none;color:var(--txt);
      padding:14px;border:1px solid var(--line);border-radius:18px;
      background:rgba(0,255,163,.05);
      transition:.15s ease;
    }
    .tile:hover{transform:translateY(-1px);border-color:rgba(0,255,163,.35);background:rgba(0,255,163,.08)}
    .tile b{color:var(--green)}
    .tile small{display:block;color:var(--muted);margin-top:4px;line-height:1.35}
    .result{
      margin-top:12px;padding:12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(0,0,0,.25);white-space:pre;overflow:auto;max-height:280px;
      font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;line-height:1.35;
    }
    .ok{border-color:rgba(0,255,163,.35);background:rgba(0,255,163,.06)}
    .err{border-color:rgba(255,77,109,.35);background:rgba(255,77,109,.08);color:rgba(255,240,245,.92)}
    .small{font-size:12px;color:var(--muted2)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div style="min-width:0">
          <h1>ConSySencI.A — Admin</h1>
          <p class="sub">Centro operacional (token único • navegação • diagnóstico)</p>
        </div>
      </div>
      <div class="right">
        <div class="pill">Status: <b id="status">deslogado</b></div>
        <button class="btn ghost" id="btnLogout" type="button">Sair</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="head">
          <h2>Acesso</h2>
          <p>Salve o token uma vez. Todas as páginas (events/rules/media) reaproveitam automaticamente.</p>
        </div>
        <div class="body">
          <div class="row">
            <div class="field">
              <label>Token Admin</label>
              <input id="token" placeholder="Cole aqui o token ADMIN_TOKEN" autocomplete="off" spellcheck="false"/>
              <div class="small" style="margin-top:8px">Dica: se aparecer <b>unauthorized</b>, token ≠ ADMIN_TOKEN do Netlify (precisa redeploy).</div>
            </div>
            <button class="btn" id="btnSave" type="button">Salvar token</button>
            <button class="btn" id="btnTest" type="button">Testar acesso</button>
          </div>

          <div id="diag" class="result ok">{ "ok": true, "info": "Pronto. Cole o token e clique em Salvar." }</div>

          <div class="nav" style="margin-top:14px">
            <a class="tile" href="/admin/events.html"><b>Eventos</b><small>Lista, filtro, detalhe e export do fluxo do observatório.</small></a>
            <a class="tile" href="/admin/rules.html"><b>Regras</b><small>Criar/editar, ativar/desativar e deletar regras do motor.</small></a>
            <a class="tile" href="/admin/media.html"><b>Mídia</b><small>Catálogo de imagens/links, upsert, delete e preview.</small></a>
          </div>

          <div class="small" style="margin-top:12px">
            Se você veio de outra página, após salvar o token você volta automaticamente para ela.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="head">
          <h2>Diagnóstico rápido</h2>
          <p>Usa a Function <b>observatory</b> para validar token + Supabase sem abrir endpoints manualmente.</p>
        </div>
        <div class="body">
          <div class="small">Endpoint testado: <code>/.netlify/functions/observatory?limit=5</code></div>
          <div class="small" style="margin-top:8px">Se sua tabela não se chama <b>core_events</b>, o teste pode falhar com <b>supabase_read_failed</b> — aí ajustamos 1 linha na function.</div>
        </div>
      </section>
    </div>
  </div>

<script>
  const LS = "ADMIN_TOKEN";
  const FN = "/.netlify/functions/observatory";
  const el = (id) => document.getElementById(id);

  function pretty(x){ try{return JSON.stringify(x,null,2)}catch{return String(x)} }
  function setBox(ok, obj){
    const box = el("diag");
    box.className = "result " + (ok ? "ok" : "err");
    box.textContent = pretty(obj);
  }
  function setStatus(s, ok=null){
    el("status").textContent = s;
    el("status").style.color = ok===true ? "var(--green)" : ok===false ? "var(--red)" : "rgba(236,255,247,.85)";
  }
  function getToken(){ return (localStorage.getItem(LS) || el("token").value || "").trim(); }

  // init
  const saved = localStorage.getItem(LS) || "";
  el("token").value = saved;
  setStatus(saved ? "logado" : "deslogado", saved ? true : null);

  el("btnLogout").onclick = () => {
    localStorage.removeItem(LS);
    el("token").value = "";
    setStatus("deslogado", null);
    setBox(true, { ok:true, logout:true });
  };

  el("btnSave").onclick = () => {
    const t = (el("token").value || "").trim();
    localStorage.setItem(LS, t);
    setStatus(t ? "logado" : "deslogado", t ? true : null);
    setBox(true, { ok:true, saved:!!t });

    // volta para a página original (next)
    const next = new URLSearchParams(location.search).get("next");
    if (next) location.href = next;
  };

  el("btnTest").onclick = async () => {
    const token = getToken();
    if (!token){
      setBox(false, { ok:false, error:"token_vazio" });
      setStatus("falha", false);
      return;
    }
    setStatus("testando...", null);
    try{
      const res = await fetch(FN + "?limit=5", { headers:{ Authorization:`Bearer ${token}`, Accept:"application/json" }});
      const text = await res.text();
      let data; try{ data = text ? JSON.parse(text) : {}; }catch{ data = { raw:text }; }
      const ok = res.ok && data && data.ok === true;
      setBox(ok, { http_ok:res.ok, status:res.status, data });
      setStatus(ok ? "logado" : "falha", ok);
    }catch(e){
      setBox(false, { ok:false, error:"network_or_server", details:String(e?.message||e) });
      setStatus("falha", false);
    }
  };
</script>
</body>
</html>
