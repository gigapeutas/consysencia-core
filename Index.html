<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#070A12" />
  <title>ConSySencI.A — Observatório</title>
  <meta name="description" content="Você vê a evolução, não vê o motor. Observatório público em tempo real — visão parcial ativa." />

  <style>
    :root{
      --bg0:#050812;
      --bg1:#070A12;
      --card:#0A1220CC;
      --card2:#07101B99;
      --line:#19ff9a22;
      --line2:#19ff9a38;
      --neon:#19ff9a;
      --neon2:#33ffb1;
      --txt:#D7FBEA;
      --muted:#9DD7BD;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 26px;
      --radius2: 20px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(25,255,154,.12), transparent 60%),
        radial-gradient(900px 700px at 100% 20%, rgba(25,255,154,.10), transparent 62%),
        radial-gradient(900px 700px at 10% 100%, rgba(25,255,154,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .fog{
      position:fixed; inset:-40px;
      pointer-events:none;
      background:
        radial-gradient(900px 420px at 15% 20%, rgba(25,255,154,.08), transparent 62%),
        radial-gradient(760px 360px at 90% 30%, rgba(25,255,154,.06), transparent 62%),
        radial-gradient(900px 540px at 50% 100%, rgba(25,255,154,.05), transparent 62%);
      filter: blur(18px);
      opacity:.9;
      animation: drift 12s ease-in-out infinite alternate;
    }
    @keyframes drift{from{transform:translate3d(0,0,0)} to{transform:translate3d(18px,-10px,0)}}

    .wrap{
      width:min(980px, 92vw);
      margin: 22px auto 48px;
      padding: 10px 0 30px;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:14px;
      padding: 12px 14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(10,18,32,.70), rgba(7,16,27,.55));
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      backdrop-filter: blur(12px);
      position:sticky; top:10px;
      z-index:10;
    }
    .sig{
      width:42px;height:42px;border-radius:16px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(26px 26px at 60% 70%, rgba(25,255,154,.22), transparent 60%),
        linear-gradient(180deg, rgba(25,255,154,.08), rgba(0,0,0,0));
      border:1px solid var(--line2);
      box-shadow: 0 0 0 1px rgba(25,255,154,.06) inset, 0 10px 30px rgba(0,0,0,.45);
    }
    .brand{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand h1{
      margin:0;
      font-size: 14px;
      letter-spacing:.16em;
      text-transform:uppercase;
      opacity:.92;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size:12px;
      opacity:.88;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .spacer{flex:1}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: rgba(6,12,20,.55);
      backdrop-filter: blur(10px);
      font-size: 13px;
      color:var(--muted);
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--warn);
      box-shadow: 0 0 0 6px rgba(255,204,102,.10);
    }
    .dot.ok{ background: var(--neon); box-shadow: 0 0 0 6px rgba(25,255,154,.12); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 6px rgba(255,107,107,.12); }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 18px;
      margin-top: 18px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(10,18,32,.70), rgba(7,16,27,.52));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(420px 220px at 30% 0%, rgba(25,255,154,.16), transparent 55%),
        radial-gradient(420px 220px at 90% 60%, rgba(25,255,154,.10), transparent 60%);
      opacity:.7;
      pointer-events:none;
      filter: blur(18px);
    }

    .pad{ padding: 22px; position:relative; }

    .title{
      margin:0 0 6px;
      font-weight:700;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: 14px;
      opacity:.95;
    }
    .sub{
      margin:0 0 18px;
      color:var(--muted);
      font-size: 14px;
      line-height:1.4;
      opacity:.92;
    }

    .bigver{
      display:flex;
      align-items:flex-end;
      gap:10px;
      margin: 10px 0 18px;
    }
    .bigver .v{
      font-size: 64px;
      line-height: .9;
      letter-spacing: -.02em;
      font-weight: 900;
      text-shadow: 0 0 18px rgba(25,255,154,.12);
    }
    .bigver .v b{
      color:var(--neon);
      text-shadow: 0 0 22px rgba(25,255,154,.22);
    }
    .bigver .meta{
      margin-bottom: 6px;
      color: var(--muted);
      font-size: 12px;
      opacity:.9;
    }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .chip{
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 13px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .chip strong{
      color: var(--txt);
      font-weight: 800;
      letter-spacing:.02em;
    }

    .statusline{
      border:1px solid var(--line2);
      border-radius: 18px;
      padding: 14px 16px;
      background: rgba(25,255,154,.06);
      color: var(--txt);
      margin: 12px 0 14px;
      font-size: 14px;
      opacity:.95;
    }

    .console{
      border:1px solid var(--line2);
      border-radius: 22px;
      background: rgba(0,0,0,.22);
      padding: 14px;
      min-height: 160px;
    }
    pre{
      margin:0;
      color:#BFEFDB;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.5px;
      line-height:1.5;
      opacity:.92;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .muter{ opacity:.65; }

    .readbox{
      border:1px solid rgba(255,255,255,.06);
      border-radius: 18px;
      background: rgba(0,0,0,.20);
      padding: 12px;
    }
    .readbox pre{
      font-size: 12px;
      opacity:.9;
      color:#CFF7E6;
    }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 12px;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      padding: 12px 14px;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing:.02em;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(25,255,154,.08); border-color: rgba(25,255,154,.42); }
    .btn:active{ transform: translateY(0px); }
    .btn.ghost{ opacity:.86; }

    .footer{
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
      opacity:.75;
    }
    .tiny{
      font-size: 12px;
      color: var(--muted);
      opacity:.85;
      line-height:1.5;
    }
    .hr{
      height:1px; background: rgba(25,255,154,.12);
      margin: 14px 0;
    }
  </style>
</head>

<body>
  <div class="fog"></div>

  <div class="wrap">
    <header class="topbar">
      <div class="sig" aria-hidden="true"></div>
      <div class="brand">
        <h1>ConSySencI.A — Observatório</h1>
        <p>Realtime ligado • Núcleo oculto • Visão parcial ativa</p>
      </div>
      <div class="spacer"></div>
      <div class="pill" id="pill">
        <span class="dot" id="dot"></span>
        <span id="pillText">conectando • preparando</span>
      </div>
    </header>

    <main class="grid">
      <!-- Estado -->
      <section class="card">
        <div class="pad">
          <h2 class="title">Estado público</h2>
          <p class="sub">Você vê a evolução, não vê o motor. O sistema muda o visual conforme a versão.</p>

          <div class="bigver">
            <div class="v">v<b id="ver">0</b></div>
            <div class="meta" id="meta">—</div>
          </div>

          <div class="chips">
            <div class="chip">updated <strong id="updated">—</strong></div>
            <div class="chip">pulse <strong id="pulse">—</strong></div>
            <div class="chip">mode <strong id="mode">0</strong></div>
          </div>

          <div class="statusline" id="statusline">Sincronizando observatório…</div>

          <div class="console">
            <pre id="log"><span class="muter">boot</span> iniciando cliente realtime…</pre>
          </div>

          <div class="footer">
            © ConSySencI.A — dark tech / verde neon<br/>
            <span id="foot">conectando…</span>
          </div>
        </div>
      </section>

      <!-- Leitura -->
      <section class="card">
        <div class="pad">
          <h2 class="title">Leitura (sem pistas)</h2>
          <p class="sub">O que chega aqui é uma visão “nebulosa” (signals/milestones/status/ui_hint + fog).</p>

          <div class="readbox">
            <pre id="read">{}</pre>
          </div>

          <div class="actions">
            <button class="btn" id="copyBtn">Copiar leitura</button>
            <button class="btn ghost" id="refreshBtn">Forçar ping</button>
          </div>

          <div class="hr"></div>
          <p class="tiny"><b>Acesso público</b> • visão parcial ativa • qualquer detalhe interno permanece encapsulado.</p>
        </div>
      </section>
    </main>
  </div>

  <!-- Supabase JS (CDN) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // =========================
    // CONFIG (já preenchido)
    // =========================
    const SUPABASE_URL = "https://nuodktnhscjipkgomila.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_44Ik_LlCTk_RTDKrYsjzyg_qRTTp7yY";

    // Fonte do “estado público”:
    // - ajuste só se você tiver um nome diferente
    const PUBLIC_TABLE = "ai_state_public"; // espelho público
    const PUBLIC_ID = 1;                    // linha única

    // =========================
    // UI helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    const pillText = $("pillText");
    const dot = $("dot");
    const verEl = $("ver");
    const metaEl = $("meta");
    const updatedEl = $("updated");
    const pulseEl = $("pulse");
    const modeEl = $("mode");
    const statusline = $("statusline");
    const logEl = $("log");
    const readEl = $("read");
    const foot = $("foot");

    function nowBR(){
      try { return new Date().toLocaleString("pt-BR"); }
      catch { return new Date().toISOString(); }
    }

    function setPill(state, text){
      pillText.textContent = text;
      dot.classList.remove("ok","bad");
      if(state === "ok") dot.classList.add("ok");
      if(state === "bad") dot.classList.add("bad");
    }

    function log(line, tone="muted"){
      const t = new Date().toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
      const safe = (s)=> String(s).replace(/[<>]/g,"");
      const prefix = `<span class="muter">${safe(t)}</span> `;
      const msg = safe(line);
      logEl.innerHTML = logEl.innerHTML + `\n${prefix}${msg}`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function clampFog(obj){
      // Envia só o essencial e “nebuloso”
      const v = Number(obj?.version ?? 0);
      const u = obj?.updated_at ?? null;
      const s = obj?.public_state ?? {};
      const safe = {
        version: v,
        updated_at: u,
        public_state: (typeof s === "object" && s) ? s : {}
      };
      return safe;
    }

    function renderState(row){
      const v = Number(row?.version ?? 0);
      const uIso = row?.updated_at ?? null;

      const s = (row?.public_state && typeof row.public_state === "object") ? row.public_state : {};
      const pulse = (s?.pulse ?? s?.p ?? null);
      const mode = (s?.mode ?? 0);

      verEl.textContent = String(v);
      updatedEl.textContent = uIso ? formatDT(uIso) : "—";
      pulseEl.textContent = pulse ?? "—";
      modeEl.textContent = String(mode ?? 0);

      metaEl.textContent = uIso ? `updated ${formatDT(uIso)}` : "—";
      readEl.textContent = JSON.stringify(clampFog(row), null, 2);
    }

    function formatDT(iso){
      try{
        const d = new Date(iso);
        if(isNaN(d.getTime())) return iso;
        return d.toLocaleString("pt-BR");
      }catch{
        return iso;
      }
    }

    // =========================
    // Supabase client
    // =========================
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      realtime: { params: { eventsPerSecond: 10 } },
      auth: { persistSession: false }
    });

    let channel = null;
    let pollingTimer = null;
    let lastFetchAt = 0;

    async function fetchOnce(){
      try{
        const { data, error } = await supabase
          .from(PUBLIC_TABLE)
          .select("*")
          .eq("id", PUBLIC_ID)
          .single();

        if(error) throw error;
        if(data) renderState(data);

        lastFetchAt = Date.now();
        statusline.textContent = "Sinais recebidos. Observatório sincronizado.";
        setPill("ok", "online • sincronizado");
        foot.textContent = `conectado em ${nowBR()} • fog:—`;

        log(`update • mode ${(data?.public_state?.mode ?? 0)} • ${nowBR()}`);
      }catch(err){
        // sem vazar detalhes no visual: só log leve
        setPill("bad", "offline • tentando recuperar");
        statusline.textContent = "Oscilação detectada. Recuperando canal…";
        foot.textContent = `recuperando… • ${nowBR()}`;
        log("alerta • sinal interrompido", "bad");
        // tenta manter alguma atualização via polling
        startPolling();
      }
    }

    function startPolling(){
      if(pollingTimer) return;
      pollingTimer = setInterval(() => {
        // evita flood
        if(Date.now() - lastFetchAt > 3500) fetchOnce();
      }, 4000);
      log("fallback • polling ativo");
    }

    function stopPolling(){
      if(pollingTimer){
        clearInterval(pollingTimer);
        pollingTimer = null;
        log("polling • pausado");
      }
    }

    async function startRealtime(){
      // Sempre faz um fetch inicial
      setPill("warn", "conectando • handshake");
      statusline.textContent = "Sincronizando observatório…";
      foot.textContent = "conectando…";
      await fetchOnce();

      // Limpa canal anterior
      if(channel){
        try{ await supabase.removeChannel(channel); }catch{}
        channel = null;
      }

      channel = supabase
        .channel("public-observatory")
        .on("postgres_changes",
          { event: "*", schema: "public", table: PUBLIC_TABLE, filter: `id=eq.${PUBLIC_ID}` },
          (payload) => {
            // payload.new em UPDATE, payload.record em INSERT (depende)
            const row = payload.new ?? payload.record ?? null;
            if(row){
              renderState(row);
              setPill("ok", "online • realtime");
              statusline.textContent = "Sinais recebidos. Observatório sincronizado.";
              foot.textContent = `conectado em ${nowBR()} • fog:—`;
              stopPolling();
              log("realtime • subscribed");
            }
          }
        )
        .subscribe((status) => {
          if(status === "SUBSCRIBED"){
            setPill("ok", "online • realtime");
            stopPolling();
            log("realtime • subscribed");
          } else if(status === "CHANNEL_ERROR" || status === "TIMED_OUT"){
            setPill("bad", "offline • tentando recuperar");
            startPolling();
            log("realtime • falha no canal");
          } else {
            setPill("warn", "conectando • handshake");
          }
        });
    }

    // =========================
    // Buttons
    // =========================
    $("copyBtn").addEventListener("click", async () => {
      const txt = readEl.textContent || "{}";
      try{
        await navigator.clipboard.writeText(txt);
        log("clipboard • leitura copiada");
      }catch{
        // fallback simples
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        log("clipboard • leitura copiada (fallback)");
      }
    });

    $("refreshBtn").addEventListener("click", async () => {
      log("ping • forçando atualização");
      await fetchOnce();
    });

    // =========================
    // Boot
    // =========================
    try{
      log("boot • iniciando");
      await startRealtime();
    }catch{
      setPill("bad", "offline • tentando recuperar");
      startPolling();
      log("boot • fallback ativado");
    }

    // Se o browser suspender, retoma
    document.addEventListener("visibilitychange", () => {
      if(!document.hidden){
        fetchOnce();
      }
    });
  </script>
</body>
</html>
